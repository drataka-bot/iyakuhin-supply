<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>医薬品供給状況検索</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Meiryo", sans-serif;
      background: #f0f4f8;
      color: #1a202c;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #1a365d 0%, #2b6cb0 100%);
      color: white;
      padding: 20px 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .header h1 {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .header p {
      font-size: 0.82rem;
      opacity: 0.85;
      margin-top: 4px;
    }
    .header-meta {
      font-size: 0.78rem;
      opacity: 0.7;
      margin-top: 2px;
    }

    /* Main container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px;
    }

    /* Info box */
    .info-box {
      background: #ebf8ff;
      border: 1px solid #bee3f8;
      border-left: 4px solid #3182ce;
      border-radius: 6px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 0.85rem;
      color: #2c5282;
    }
    .info-box a {
      color: #2b6cb0;
      font-weight: 600;
    }
    .info-box a:hover { text-decoration: none; }
    .info-box .mhlw-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 6px;
      background: #2b6cb0;
      color: white;
      padding: 5px 12px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 0.82rem;
    }
    .info-box .mhlw-link:hover { background: #2c5282; }

    /* Upload area */
    .upload-section {
      background: white;
      border-radius: 10px;
      padding: 24px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .upload-area {
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      padding: 36px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #f7fafc;
    }
    .upload-area:hover, .upload-area.drag-over {
      border-color: #3182ce;
      background: #ebf8ff;
    }
    .upload-icon {
      font-size: 2.4rem;
      margin-bottom: 10px;
    }
    .upload-area h3 {
      font-size: 1rem;
      color: #2d3748;
      margin-bottom: 6px;
    }
    .upload-area p {
      font-size: 0.82rem;
      color: #718096;
    }
    .upload-btn {
      display: inline-block;
      margin-top: 12px;
      background: #3182ce;
      color: white;
      padding: 8px 20px;
      border-radius: 6px;
      font-size: 0.88rem;
      cursor: pointer;
      border: none;
    }
    .upload-btn:hover { background: #2b6cb0; }
    #fileInput { display: none; }

    /* Loading / Status bar */
    .status-bar {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: #f0fff4;
      border: 1px solid #9ae6b4;
      border-radius: 6px;
      font-size: 0.85rem;
      color: #276749;
      margin-top: 12px;
    }
    .status-bar.error {
      background: #fff5f5;
      border-color: #feb2b2;
      color: #c53030;
    }
    .status-bar.loading {
      background: #ebf8ff;
      border-color: #90cdf4;
      color: #2c5282;
    }
    .spinner {
      width: 16px; height: 16px;
      border: 2px solid #90cdf4;
      border-top-color: #3182ce;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Search & filter */
    .search-section {
      display: none;
      background: white;
      border-radius: 10px;
      padding: 20px 24px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .search-row {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
    }
    .search-input {
      flex: 1;
      padding: 10px 14px;
      font-size: 0.95rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      outline: none;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: #3182ce; }
    .search-btn {
      padding: 10px 20px;
      background: #3182ce;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      font-family: inherit;
    }
    .search-btn:hover { background: #2b6cb0; }
    .clear-btn {
      padding: 10px 14px;
      background: #e2e8f0;
      color: #4a5568;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      font-family: inherit;
    }
    .clear-btn:hover { background: #cbd5e0; }

    /* Search hints */
    .search-hint {
      font-size: 0.78rem;
      color: #718096;
      margin-bottom: 14px;
    }

    /* Filter buttons */
    .filter-label {
      font-size: 0.82rem;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
    }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .filter-btn {
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 0.82rem;
      cursor: pointer;
      border: 2px solid transparent;
      font-family: inherit;
      transition: all 0.15s;
      font-weight: 500;
    }
    .filter-btn.all { background: #edf2f7; color: #4a5568; border-color: #cbd5e0; }
    .filter-btn.all.active, .filter-btn.all:hover { background: #4a5568; color: white; }
    .filter-btn.normal { background: #f0fff4; color: #276749; border-color: #9ae6b4; }
    .filter-btn.normal.active, .filter-btn.normal:hover { background: #48bb78; color: white; border-color: #48bb78; }
    .filter-btn.limited { background: #fffaf0; color: #c05621; border-color: #fbd38d; }
    .filter-btn.limited.active, .filter-btn.limited:hover { background: #ed8936; color: white; border-color: #ed8936; }
    .filter-btn.stopped { background: #fff5f5; color: #c53030; border-color: #feb2b2; }
    .filter-btn.stopped.active, .filter-btn.stopped:hover { background: #e53e3e; color: white; border-color: #e53e3e; }

    /* Results */
    .results-section {
      display: none;
    }
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .results-count {
      font-size: 0.88rem;
      color: #4a5568;
    }
    .results-count strong { color: #2d3748; }
    .export-btn {
      padding: 6px 14px;
      background: white;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 0.82rem;
      cursor: pointer;
      color: #4a5568;
      font-family: inherit;
    }
    .export-btn:hover { background: #f7fafc; }

    /* Table */
    .table-wrapper {
      background: white;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .table-scroll {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    thead { background: #2d3748; color: white; }
    thead th {
      padding: 11px 12px;
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
      font-size: 0.8rem;
    }
    tbody tr {
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.1s;
    }
    tbody tr:hover { background: #f7fafc; }
    tbody td {
      padding: 10px 12px;
      vertical-align: middle;
    }
    td.brand-name { font-weight: 500; color: #2d3748; white-space: nowrap; min-width: 180px; }
    td.generic-name { color: #4a5568; font-size: 0.82rem; white-space: nowrap; min-width: 140px; }
    td.manufacturer { color: #718096; font-size: 0.8rem; white-space: nowrap; min-width: 80px; }
    td.unit { white-space: nowrap; min-width: 100px; }
    td.yj-code { font-family: monospace; font-size: 0.78rem; color: #718096; white-space: nowrap; min-width: 110px; }
    td.status-cell { white-space: nowrap; min-width: 140px; }
    td.reason { font-size: 0.78rem; color: #718096; min-width: 120px; max-width: 200px; }
    thead th { white-space: nowrap; }
    tbody td { padding: 8px 12px; }

    /* Status badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.78rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .badge-normal { background: #f0fff4; color: #276749; border: 1px solid #9ae6b4; }
    .badge-limited-self { background: #fffaf0; color: #c05621; border: 1px solid #fbd38d; }
    .badge-limited-other { background: #fffff0; color: #975a16; border: 1px solid #f6e05e; }
    .badge-limited-misc { background: #fff5f5; color: #9c4221; border: 1px solid #fca5a5; }
    .badge-stopped { background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; }
    .badge-unknown { background: #f7fafc; color: #718096; border: 1px solid #e2e8f0; }

    /* Status dot */
    .dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      display: inline-block;
    }
    .dot-normal { background: #48bb78; }
    .dot-limited { background: #ed8936; }
    .dot-stopped { background: #e53e3e; }
    .dot-unknown { background: #a0aec0; }

    /* No results */
    .no-results {
      text-align: center;
      padding: 48px 20px;
      color: #718096;
    }
    .no-results .icon { font-size: 2.5rem; margin-bottom: 10px; }
    .no-results p { font-size: 0.9rem; }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      padding: 16px;
      background: white;
      border-top: 1px solid #f0f0f0;
    }
    .page-btn {
      padding: 5px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.82rem;
      background: white;
      color: #4a5568;
      font-family: inherit;
    }
    .page-btn:hover:not(:disabled) { background: #ebf8ff; border-color: #90cdf4; }
    .page-btn.active { background: #3182ce; color: white; border-color: #3182ce; }
    .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .page-info { font-size: 0.82rem; color: #718096; padding: 0 4px; }

    /* Data info */
    .data-info-bar {
      display: none;
      align-items: center;
      justify-content: space-between;
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 8px 14px;
      margin-bottom: 14px;
      font-size: 0.82rem;
      color: #4a5568;
    }
    .data-info-bar .reload-btn {
      color: #3182ce;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 0.82rem;
      padding: 0;
      font-family: inherit;
    }
    .data-info-bar .reload-btn:hover { text-decoration: underline; }

    /* Stats cards */
    .stats-row {
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 14px 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.07);
      text-align: center;
    }
    .stat-card .stat-num {
      font-size: 1.6rem;
      font-weight: 700;
      line-height: 1;
    }
    .stat-card .stat-label {
      font-size: 0.75rem;
      color: #718096;
      margin-top: 4px;
    }
    .stat-normal .stat-num { color: #48bb78; }
    .stat-limited .stat-num { color: #ed8936; }
    .stat-stopped .stat-num { color: #e53e3e; }
    .stat-total .stat-num { color: #4299e1; }

    @media (max-width: 640px) {
      .header h1 { font-size: 1.1rem; }
      .search-row { flex-direction: column; }
      .results-header { flex-direction: column; align-items: flex-start; gap: 8px; }
      thead th:nth-child(4), tbody td:nth-child(4),
      thead th:nth-child(5), tbody td:nth-child(5) { display: none; }
    }
  </style>
</head>
<body>

<div class="header">
  <h1>医薬品供給状況検索システム</h1>
  <p>厚生労働省「医療用医薬品供給状況」Excelファイルを読み込み、出荷状況を検索できます</p>
</div>

<div class="container">

  <!-- Info box -->
  <div class="info-box">
    <strong>使い方：</strong>
    厚生労働省のサイトから最新のExcelファイルをダウンロードし、下のエリアにアップロードしてください。<br>
    <a class="mhlw-link" href="https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/kenkou_iryou/iryou/kouhatu-iyaku/04_00003.html" target="_blank" rel="noopener">
      &#x1F517; 厚生労働省 医療用医薬品供給状況ページを開く
    </a>
  </div>

  <!-- Data info bar (shown after load) -->
  <div class="data-info-bar" id="dataInfoBar">
    <span id="dataInfoText"></span>
    <button class="reload-btn" onclick="resetApp()">&#x21BA; 別のファイルを読み込む</button>
  </div>

  <!-- Stats cards -->
  <div class="stats-row" id="statsRow">
    <div class="stat-card stat-total">
      <div class="stat-num" id="statTotal">0</div>
      <div class="stat-label">総品目数</div>
    </div>
    <div class="stat-card stat-normal">
      <div class="stat-num" id="statNormal">0</div>
      <div class="stat-label">通常出荷</div>
    </div>
    <div class="stat-card stat-limited">
      <div class="stat-num" id="statLimited">0</div>
      <div class="stat-label">限定出荷</div>
    </div>
    <div class="stat-card stat-stopped">
      <div class="stat-num" id="statStopped">0</div>
      <div class="stat-label">供給停止</div>
    </div>
  </div>

  <!-- Upload section -->
  <div class="upload-section" id="uploadSection">
    <div class="upload-area" id="uploadArea"
         onclick="document.getElementById('fileInput').click()"
         ondragover="handleDragOver(event)"
         ondragleave="handleDragLeave(event)"
         ondrop="handleDrop(event)">
      <div class="upload-icon">&#x1F4C2;</div>
      <h3>Excelファイルをアップロード</h3>
      <p>ここにファイルをドラッグ＆ドロップ、またはクリックして選択</p>
      <p style="margin-top:4px; font-size:0.78rem;">対応形式：.xlsx / .xls</p>
      <button class="upload-btn" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">
        ファイルを選択
      </button>
    </div>
    <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
    <div class="status-bar" id="statusBar">
      <div class="spinner" id="statusSpinner"></div>
      <span id="statusText"></span>
    </div>
  </div>

  <!-- Search section -->
  <div class="search-section" id="searchSection">
    <div class="search-row">
      <input type="text" class="search-input" id="searchInput"
             placeholder="医薬品名（品名・成分名・メーカー）で検索..."
             oninput="handleSearchInput()"
             onkeydown="if(event.key==='Enter') performSearch()">
      <button class="search-btn" onclick="performSearch()">検索</button>
      <button class="clear-btn" onclick="clearSearch()">クリア</button>
    </div>
    <div class="search-hint">例：「アスピリン」「ロキソプロフェン」「メトホルミン」でも検索できます</div>
    <div class="filter-label">出荷状況でフィルタ</div>
    <div class="filter-row">
      <button class="filter-btn all active" onclick="setFilter('all', this)">すべて</button>
      <button class="filter-btn normal" onclick="setFilter('normal', this)">&#x25CF; 通常出荷</button>
      <button class="filter-btn limited" onclick="setFilter('limited', this)">&#x26A0; 限定出荷</button>
      <button class="filter-btn stopped" onclick="setFilter('stopped', this)">&#x2715; 供給停止</button>
    </div>
  </div>

  <!-- Results section -->
  <div class="results-section" id="resultsSection">
    <div class="results-header">
      <div class="results-count" id="resultsCount"></div>
      <button class="export-btn" onclick="exportCSV()">&#x1F4E5; CSVエクスポート</button>
    </div>
    <div class="table-wrapper">
      <div class="table-scroll">
        <table id="resultsTable">
          <thead>
            <tr>
              <th>品名</th>
              <th>成分名</th>
              <th>製造販売業者</th>
              <th>規格単位</th>
              <th>YJコード</th>
              <th>出荷状況</th>
              <th>停止理由</th>
              <th>解消見込み</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

</div>

<script>
  // =========================================================
  // State
  // =========================================================
  let allData = [];        // 全データ（行オブジェクト配列）
  let filteredData = [];   // 検索/フィルタ後データ
  let currentFilter = 'all';
  let currentSearch = '';
  let currentPage = 1;
  const PAGE_SIZE = 50;

  // =========================================================
  // Column indices (0-based, row 0 = header)
  // ①薬剤区分=0, ②薬効分類=1, ③成分名=2, ④規格単位=3, ⑤YJコード=4,
  // ⑥品名=5, ⑦製造販売業者名=6, ⑧製品区分=7, ⑨基礎的=8, ⑩供給確保=9,
  // ⑪薬価収載=10, ⑫出荷対応=11, ⑬更新日=12, ⑭理由=13, ⑮解消見込み=14, ⑯時期=15
  // =========================================================
  const COL = {
    DRUG_CLASS: 0,
    PHARM_CLASS: 1,
    GENERIC: 2,
    UNIT: 3,
    YJ: 4,
    BRAND: 5,
    MAKER: 6,
    PRODUCT_TYPE: 7,
    BASIC: 8,
    ENSURE: 9,
    PRICE_DATE: 10,
    STATUS: 11,
    UPDATE_DATE: 12,
    REASON: 13,
    RESOLUTION: 14,
    RESOLUTION_DATE: 15,
  };

  // =========================================================
  // Status classification
  // =========================================================
  function classifyStatus(val) {
    if (!val) return 'unknown';
    const s = String(val);
    if (s.includes('供給停止') || s.startsWith('⑤')) return 'stopped';
    if (s.includes('限定出荷') || s.startsWith('②') || s.startsWith('③') || s.startsWith('④')) return 'limited';
    if (s.includes('通常出荷') || s.startsWith('①')) return 'normal';
    return 'unknown';
  }

  function buildBadge(val) {
    const s = String(val || '');
    const cls = classifyStatus(val);
    const dotCls = cls === 'normal' ? 'dot-normal' : cls === 'limited' ? 'dot-limited' : cls === 'stopped' ? 'dot-stopped' : 'dot-unknown';
    const badgeCls = cls === 'normal' ? 'badge-normal'
                   : s.includes('自社') ? 'badge-limited-self'
                   : s.includes('他社') ? 'badge-limited-other'
                   : cls === 'limited' ? 'badge-limited-misc'
                   : cls === 'stopped' ? 'badge-stopped'
                   : 'badge-unknown';
    // Short label
    let label = s;
    if (s.startsWith('①')) label = '通常出荷';
    else if (s.includes('自社の事情')) label = '限定出荷（自社）';
    else if (s.includes('他社品の影響')) label = '限定出荷（他社影響）';
    else if (s.includes('その他')) label = '限定出荷（その他）';
    else if (s.includes('供給停止')) label = '供給停止';
    return `<span class="badge ${badgeCls}"><span class="dot ${dotCls}"></span>${escHtml(label)}</span>`;
  }

  // =========================================================
  // Drag & Drop
  // =========================================================
  function handleDragOver(e) {
    e.preventDefault();
    document.getElementById('uploadArea').classList.add('drag-over');
  }
  function handleDragLeave(e) {
    document.getElementById('uploadArea').classList.remove('drag-over');
  }
  function handleDrop(e) {
    e.preventDefault();
    document.getElementById('uploadArea').classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) processFile(file);
  }
  function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) processFile(file);
  }

  // =========================================================
  // File processing
  // =========================================================
  function processFile(file) {
    if (!file.name.match(/\.(xlsx|xls)$/i)) {
      showStatus('error', 'Excelファイル（.xlsx / .xls）を選択してください');
      return;
    }
    showStatus('loading', `「${file.name}」を読み込んでいます...`);

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
        const sheetName = workbook.SheetNames[0];
        const ws = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

        // Skip header row(s): find first row that looks like data
        // Row 0 = column headers, row 1 onwards = data
        const dataRows = [];
        let headerFound = false;
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const statusVal = row[COL.STATUS] ? String(row[COL.STATUS]) : '';
          // Data rows have status values starting with ①②③④⑤
          if (!headerFound && (statusVal.startsWith('①') || statusVal.startsWith('②') || statusVal.startsWith('③') || statusVal.startsWith('④') || statusVal.startsWith('⑤'))) {
            headerFound = true;
          }
          if (headerFound) {
            const brand = String(row[COL.BRAND] || '').trim();
            const generic = String(row[COL.GENERIC] || '').trim();
            if (brand || generic) {
              dataRows.push(row);
            }
          }
        }

        if (dataRows.length === 0) {
          showStatus('error', 'データが見つかりませんでした。正しいファイルか確認してください。');
          return;
        }

        allData = dataRows;
        hideStatus();
        initApp(file.name, file.lastModified);
      } catch (err) {
        showStatus('error', `読み込みエラー: ${err.message}`);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function initApp(filename, modDate) {
    // Compute stats
    let normal = 0, limited = 0, stopped = 0;
    allData.forEach(row => {
      const cls = classifyStatus(row[COL.STATUS]);
      if (cls === 'normal') normal++;
      else if (cls === 'limited') limited++;
      else if (cls === 'stopped') stopped++;
    });

    document.getElementById('statTotal').textContent = allData.length.toLocaleString();
    document.getElementById('statNormal').textContent = normal.toLocaleString();
    document.getElementById('statLimited').textContent = limited.toLocaleString();
    document.getElementById('statStopped').textContent = stopped.toLocaleString();

    const dateStr = modDate ? new Date(modDate).toLocaleDateString('ja-JP') : '';
    document.getElementById('dataInfoText').textContent =
      `読み込み済み：${filename}　全 ${allData.length.toLocaleString()} 品目${dateStr ? '　（ファイル更新日：' + dateStr + '）' : ''}`;

    // Show/hide sections
    document.getElementById('uploadSection').style.display = 'none';
    document.getElementById('dataInfoBar').style.display = 'flex';
    document.getElementById('statsRow').style.display = 'grid';
    document.getElementById('searchSection').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'block';

    // Initial display: all data
    currentFilter = 'all';
    currentSearch = '';
    currentPage = 1;
    applyFilters();
  }

  // =========================================================
  // Search & Filter
  // =========================================================
  let searchTimer = null;
  function handleSearchInput() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(performSearch, 300);
  }

  function performSearch() {
    currentSearch = document.getElementById('searchInput').value.trim();
    currentPage = 1;
    applyFilters();
  }

  function clearSearch() {
    document.getElementById('searchInput').value = '';
    currentSearch = '';
    currentPage = 1;
    applyFilters();
  }

  function setFilter(filter, btn) {
    currentFilter = filter;
    currentPage = 1;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    applyFilters();
  }

  function applyFilters() {
    const q = currentSearch.toLowerCase();
    filteredData = allData.filter(row => {
      // Status filter
      if (currentFilter !== 'all') {
        const cls = classifyStatus(row[COL.STATUS]);
        if (cls !== currentFilter) return false;
      }
      // Search filter
      if (q) {
        const brand = String(row[COL.BRAND] || '').toLowerCase();
        const generic = String(row[COL.GENERIC] || '').toLowerCase();
        const maker = String(row[COL.MAKER] || '').toLowerCase();
        const yj = String(row[COL.YJ] || '').toLowerCase();
        const unit = String(row[COL.UNIT] || '').toLowerCase();
        if (!brand.includes(q) && !generic.includes(q) && !maker.includes(q) && !yj.includes(q) && !unit.includes(q)) {
          return false;
        }
      }
      return true;
    });

    renderResults();
  }

  // =========================================================
  // Rendering
  // =========================================================
  function escHtml(s) {
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function highlightMatch(text, query) {
    if (!query) return escHtml(text);
    const q = query.toLowerCase();
    const t = String(text || '');
    const idx = t.toLowerCase().indexOf(q);
    if (idx < 0) return escHtml(t);
    return escHtml(t.slice(0, idx))
      + `<mark style="background:#fef08a;padding:0 1px">${escHtml(t.slice(idx, idx + q.length))}</mark>`
      + escHtml(t.slice(idx + q.length));
  }

  function renderResults() {
    const total = filteredData.length;
    const start = (currentPage - 1) * PAGE_SIZE;
    const end = Math.min(start + PAGE_SIZE, total);
    const pageData = filteredData.slice(start, end);

    // Count text
    const q = currentSearch;
    let countText = `<strong>${total.toLocaleString()}</strong> 品目`;
    if (q) countText += ` 「${escHtml(q)}」の検索結果`;
    if (currentFilter !== 'all') {
      const labels = { normal:'通常出荷', limited:'限定出荷', stopped:'供給停止' };
      countText += ` [${labels[currentFilter] || currentFilter}]`;
    }
    document.getElementById('resultsCount').innerHTML = countText;

    const tbody = document.getElementById('tableBody');
    if (pageData.length === 0) {
      tbody.innerHTML = `<tr><td colspan="8">
        <div class="no-results">
          <div class="icon">&#x1F50D;</div>
          <p>該当する医薬品が見つかりませんでした</p>
        </div>
      </td></tr>`;
    } else {
      tbody.innerHTML = pageData.map(row => {
        const brand = String(row[COL.BRAND] || '');
        const generic = String(row[COL.GENERIC] || '');
        const maker = String(row[COL.MAKER] || '');
        const unit = String(row[COL.UNIT] || '');
        const yj = String(row[COL.YJ] || '');
        const status = row[COL.STATUS];
        const reason = String(row[COL.REASON] || '');
        const resolution = String(row[COL.RESOLUTION] || '');

        return `<tr>
          <td class="brand-name">${highlightMatch(brand, q)}</td>
          <td class="generic-name">${highlightMatch(generic, q)}</td>
          <td class="manufacturer">${highlightMatch(maker, q)}</td>
          <td class="unit">${escHtml(unit)}</td>
          <td class="yj-code">${escHtml(yj)}</td>
          <td class="status-cell">${buildBadge(status)}</td>
          <td class="reason">${escHtml(reason.replace(/^[１-９\d]．\s*/,''))}</td>
          <td class="reason">${escHtml(resolution.replace(/^[ア-オA-Z]．\s*/,''))}</td>
        </tr>`;
      }).join('');
    }

    renderPagination(total);
  }

  function renderPagination(total) {
    const totalPages = Math.ceil(total / PAGE_SIZE);
    const pag = document.getElementById('pagination');
    if (totalPages <= 1) { pag.innerHTML = ''; return; }

    let html = '';
    html += `<button class="page-btn" onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&#x2039; 前へ</button>`;

    // Page numbers
    const range = [];
    range.push(1);
    if (currentPage > 3) range.push('...');
    for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) range.push(i);
    if (currentPage < totalPages - 2) range.push('...');
    if (totalPages > 1) range.push(totalPages);

    range.forEach(p => {
      if (p === '...') {
        html += `<span class="page-info">…</span>`;
      } else {
        html += `<button class="page-btn ${p === currentPage ? 'active' : ''}" onclick="goPage(${p})">${p}</button>`;
      }
    });

    html += `<button class="page-btn" onclick="goPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>次へ &#x203A;</button>`;
    html += `<span class="page-info">${(currentPage - 1) * PAGE_SIZE + 1}–${Math.min(currentPage * PAGE_SIZE, total)} / ${total.toLocaleString()}</span>`;

    pag.innerHTML = html;
  }

  function goPage(page) {
    const totalPages = Math.ceil(filteredData.length / PAGE_SIZE);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderResults();
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // =========================================================
  // Status helpers
  // =========================================================
  function showStatus(type, text) {
    const bar = document.getElementById('statusBar');
    const spinner = document.getElementById('statusSpinner');
    bar.className = `status-bar ${type}`;
    bar.style.display = 'flex';
    spinner.style.display = type === 'loading' ? 'block' : 'none';
    document.getElementById('statusText').textContent = text;
  }
  function hideStatus() {
    document.getElementById('statusBar').style.display = 'none';
  }

  // =========================================================
  // Reset
  // =========================================================
  function resetApp() {
    allData = [];
    filteredData = [];
    currentFilter = 'all';
    currentSearch = '';
    currentPage = 1;

    document.getElementById('fileInput').value = '';
    document.getElementById('searchInput').value = '';
    document.getElementById('uploadSection').style.display = 'block';
    document.getElementById('dataInfoBar').style.display = 'none';
    document.getElementById('statsRow').style.display = 'none';
    document.getElementById('searchSection').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'none';
    hideStatus();

    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.filter-btn.all').classList.add('active');
  }

  // =========================================================
  // CSV Export
  // =========================================================
  function exportCSV() {
    if (filteredData.length === 0) return;
    const headers = ['品名', '成分名', '製造販売業者', '規格単位', 'YJコード', '薬剤区分', '製品区分', '出荷状況', '停止理由', '解消見込み', '解消見込み時期'];
    const rows = filteredData.map(row => [
      row[COL.BRAND], row[COL.GENERIC], row[COL.MAKER], row[COL.UNIT], row[COL.YJ],
      row[COL.DRUG_CLASS], row[COL.PRODUCT_TYPE], row[COL.STATUS],
      row[COL.REASON], row[COL.RESOLUTION], row[COL.RESOLUTION_DATE]
    ]);
    const csv = [headers, ...rows].map(r =>
      r.map(cell => {
        const s = String(cell || '').replace(/"/g, '""');
        return s.includes(',') || s.includes('"') || s.includes('\n') ? `"${s}"` : s;
      }).join(',')
    ).join('\r\n');
    const bom = '\uFEFF';
    const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `医薬品供給状況_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }
</script>

</body>
</html>
