<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>医薬品供給状況検索</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Sans", "Meiryo", sans-serif;
      background: #f0f4f8;
      color: #1a202c;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #1a365d 0%, #2b6cb0 100%);
      color: white;
      padding: 20px 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }
    .header h1 {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .header p {
      font-size: 0.82rem;
      opacity: 0.85;
      margin-top: 4px;
    }
    .header-meta {
      font-size: 0.78rem;
      opacity: 0.7;
      margin-top: 2px;
    }
    .header-watch-btn {
      flex-shrink: 0;
      background: rgba(255,255,255,0.15);
      color: white;
      border: 1.5px solid rgba(255,255,255,0.4);
      padding: 8px 16px;
      border-radius: 24px;
      cursor: pointer;
      font-size: 0.88rem;
      font-family: inherit;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .header-watch-btn:hover { background: rgba(255,255,255,0.25); }
    .header-watch-btn.active { background: rgba(255,255,255,0.35); }
    .watch-badge {
      background: #f6ad55;
      color: #7b341e;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 1px 7px;
      border-radius: 12px;
      min-width: 22px;
      text-align: center;
    }

    /* Main container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px;
    }

    /* Notification banner */
    .notif-banner {
      display: none;
      background: linear-gradient(135deg, #744210, #c05621);
      color: white;
      padding: 16px 20px;
      border-radius: 10px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .notif-banner-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .notif-section-title {
      font-weight: 600;
      font-size: 0.88rem;
      margin: 8px 0 6px;
      opacity: 0.9;
    }
    .notif-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px 10px;
      border-radius: 6px;
      margin-bottom: 4px;
      font-size: 0.88rem;
    }
    .notif-item.improved { background: rgba(72,187,120,0.25); }
    .notif-item.worsened { background: rgba(229,62,62,0.25); }
    .notif-drug { font-weight: 600; flex: 1; }
    .notif-arrow { opacity: 0.9; font-size: 0.82rem; white-space: nowrap; }
    .notif-close-btn {
      margin-top: 12px;
      background: rgba(255,255,255,0.2);
      border: none;
      padding: 5px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.82rem;
      color: white;
      font-family: inherit;
    }
    .notif-close-btn:hover { background: rgba(255,255,255,0.3); }
    .notif-allow-btn {
      margin-left: 8px;
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.4);
      padding: 5px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.82rem;
      color: white;
      font-family: inherit;
    }
    .notif-allow-btn:hover { background: rgba(255,255,255,0.3); }

    /* Notification permission prompt */
    .notif-prompt {
      display: none;
      background: #fffaf0;
      border: 1px solid #fbd38d;
      border-left: 4px solid #ed8936;
      border-radius: 6px;
      padding: 10px 16px;
      margin-bottom: 14px;
      font-size: 0.85rem;
      color: #7b341e;
      align-items: center;
      gap: 12px;
    }
    .notif-prompt-text { flex: 1; }
    .notif-prompt-btn {
      background: #ed8936;
      color: white;
      border: none;
      padding: 5px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.82rem;
      font-family: inherit;
      white-space: nowrap;
    }
    .notif-prompt-btn:hover { background: #c05621; }

    /* Info box */
    .info-box {
      background: #ebf8ff;
      border: 1px solid #bee3f8;
      border-left: 4px solid #3182ce;
      border-radius: 6px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 0.85rem;
      color: #2c5282;
    }
    .info-box a {
      color: #2b6cb0;
      font-weight: 600;
    }
    .info-box a:hover { text-decoration: none; }
    .info-box .mhlw-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 6px;
      background: #2b6cb0;
      color: white;
      padding: 5px 12px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 0.82rem;
    }
    .info-box .mhlw-link:hover { background: #2c5282; }

    /* Upload area */
    .upload-section {
      background: white;
      border-radius: 10px;
      padding: 24px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .upload-area {
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      padding: 36px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #f7fafc;
    }
    .upload-area:hover, .upload-area.drag-over {
      border-color: #3182ce;
      background: #ebf8ff;
    }
    .upload-icon {
      font-size: 2.4rem;
      margin-bottom: 10px;
    }
    .upload-area h3 {
      font-size: 1rem;
      color: #2d3748;
      margin-bottom: 6px;
    }
    .upload-area p {
      font-size: 0.82rem;
      color: #718096;
    }
    .upload-btn {
      display: inline-block;
      margin-top: 12px;
      background: #3182ce;
      color: white;
      padding: 8px 20px;
      border-radius: 6px;
      font-size: 0.88rem;
      cursor: pointer;
      border: none;
    }
    .upload-btn:hover { background: #2b6cb0; }
    #fileInput { display: none; }

    /* Loading / Status bar */
    .status-bar {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: #f0fff4;
      border: 1px solid #9ae6b4;
      border-radius: 6px;
      font-size: 0.85rem;
      color: #276749;
      margin-top: 12px;
    }
    .status-bar.error {
      background: #fff5f5;
      border-color: #feb2b2;
      color: #c53030;
    }
    .status-bar.loading {
      background: #ebf8ff;
      border-color: #90cdf4;
      color: #2c5282;
    }
    .spinner {
      width: 16px; height: 16px;
      border: 2px solid #90cdf4;
      border-top-color: #3182ce;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Search & filter */
    .search-section {
      display: none;
      background: white;
      border-radius: 10px;
      padding: 20px 24px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .search-row {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
    }
    .search-input {
      flex: 1;
      padding: 10px 14px;
      font-size: 0.95rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      outline: none;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: #3182ce; }
    .search-btn {
      padding: 10px 20px;
      background: #3182ce;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      font-family: inherit;
    }
    .search-btn:hover { background: #2b6cb0; }
    .clear-btn {
      padding: 10px 14px;
      background: #e2e8f0;
      color: #4a5568;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      font-family: inherit;
    }
    .clear-btn:hover { background: #cbd5e0; }

    /* Search hints */
    .search-hint {
      font-size: 0.78rem;
      color: #718096;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .mode-toggle { display: flex; gap: 4px; }
    .mode-btn {
      padding: 2px 10px;
      border-radius: 12px;
      border: 1px solid #cbd5e0;
      background: white;
      color: #4a5568;
      font-size: 0.75rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .mode-btn.active { background: #3182ce; color: white; border-color: #3182ce; }
    .mode-btn:not(.active):hover { background: #edf2f7; }

    /* Filter buttons */
    .filter-label {
      font-size: 0.82rem;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 8px;
    }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .filter-btn {
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 0.82rem;
      cursor: pointer;
      border: 2px solid transparent;
      font-family: inherit;
      transition: all 0.15s;
      font-weight: 500;
    }
    .filter-btn.all { background: #edf2f7; color: #4a5568; border-color: #cbd5e0; }
    .filter-btn.all.active, .filter-btn.all:hover { background: #4a5568; color: white; }
    .filter-btn.normal { background: #f0fff4; color: #276749; border-color: #9ae6b4; }
    .filter-btn.normal.active, .filter-btn.normal:hover { background: #48bb78; color: white; border-color: #48bb78; }
    .filter-btn.limited { background: #fffaf0; color: #c05621; border-color: #fbd38d; }
    .filter-btn.limited.active, .filter-btn.limited:hover { background: #ed8936; color: white; border-color: #ed8936; }
    .filter-btn.stopped { background: #fff5f5; color: #c53030; border-color: #feb2b2; }
    .filter-btn.stopped.active, .filter-btn.stopped:hover { background: #e53e3e; color: white; border-color: #e53e3e; }

    /* Results */
    .results-section {
      display: none;
    }
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .results-count {
      font-size: 0.88rem;
      color: #4a5568;
    }
    .results-count strong { color: #2d3748; }
    .export-btn {
      padding: 6px 14px;
      background: white;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 0.82rem;
      cursor: pointer;
      color: #4a5568;
      font-family: inherit;
    }
    .export-btn:hover { background: #f7fafc; }

    /* Table */
    .table-wrapper {
      background: white;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      /* overflow:hidden を外すと sticky が効く。角丸はtable-scrollに移譲 */
    }
    .table-scroll {
      border-radius: 10px;
    }
    .table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    thead { background: #2d3748; color: white; }
    thead th {
      padding: 11px 12px;
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
      font-size: 0.8rem;
    }
    tbody tr {
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.1s;
    }
    tbody tr:hover { background: #f7fafc; }
    tbody tr.status-changed { background: #fffaf0; }
    tbody tr.status-changed:hover { background: #fef3c7; }
    tbody td {
      padding: 10px 12px;
      vertical-align: middle;
    }
    td.brand-name { font-weight: 500; color: #2d3748; white-space: nowrap; min-width: 180px; }
    td.generic-name { color: #4a5568; font-size: 0.82rem; white-space: nowrap; min-width: 140px; }
    td.manufacturer { color: #718096; font-size: 0.8rem; white-space: nowrap; min-width: 80px; }
    td.unit { white-space: nowrap; min-width: 100px; }
    td.yj-code { font-family: monospace; font-size: 0.78rem; color: #718096; white-space: nowrap; min-width: 110px; }
    td.status-cell { white-space: nowrap; min-width: 140px; }
    td.reason { font-size: 0.78rem; color: #718096; min-width: 120px; max-width: 200px; }
    thead th { white-space: nowrap; }
    tbody td { padding: 8px 12px; }

    /* Sticky columns (watch + brand) */
    td.watch-col, th.watch-col {
      text-align: center; width: 42px; min-width: 42px; padding: 8px 4px;
      position: sticky; left: 0; z-index: 1;
      background: white;
    }
    thead th.watch-col { background: #2d3748; z-index: 2; }
    tbody tr:hover td.watch-col { background: #f7fafc; }
    tbody tr.status-changed td.watch-col { background: #fffaf0; }
    tbody tr.status-changed:hover td.watch-col { background: #fef3c7; }
    td.brand-name, th:nth-child(2) {
      position: sticky; left: 42px; z-index: 1;
      background: white;
    }
    thead th:nth-child(2) { background: #2d3748; z-index: 2; }
    tbody tr:hover td.brand-name { background: #f7fafc; }
    tbody tr.status-changed td.brand-name { background: #fffaf0; }
    tbody tr.status-changed:hover td.brand-name { background: #fef3c7; }

    /* Scroll shadow indicator */
    .table-scroll {
      position: relative;
    }
    .table-scroll::after {
      content: '';
      position: absolute;
      top: 0; right: 0; bottom: 0;
      width: 24px;
      background: linear-gradient(to right, transparent, rgba(0,0,0,0.06));
      pointer-events: none;
    }
    .watch-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 2px 4px;
      color: #cbd5e0;
      transition: color 0.15s, transform 0.15s;
      line-height: 1;
    }
    .watch-btn:hover { color: #ed8936; transform: scale(1.2); }
    .watch-btn.watched { color: #f6ad55; }
    .prev-status {
      display: block;
      font-size: 0.72rem;
      color: #ed8936;
      margin-top: 3px;
    }

    /* Status badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.78rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .badge-normal { background: #f0fff4; color: #276749; border: 1px solid #9ae6b4; }
    .badge-limited-self { background: #fffaf0; color: #c05621; border: 1px solid #fbd38d; }
    .badge-limited-other { background: #fffff0; color: #975a16; border: 1px solid #f6e05e; }
    .badge-limited-misc { background: #fff5f5; color: #9c4221; border: 1px solid #fca5a5; }
    .badge-stopped { background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; }
    .badge-unknown { background: #f7fafc; color: #718096; border: 1px solid #e2e8f0; }

    /* Status dot */
    .dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      display: inline-block;
    }
    .dot-normal { background: #48bb78; }
    .dot-limited { background: #ed8936; }
    .dot-stopped { background: #e53e3e; }
    .dot-unknown { background: #a0aec0; }

    /* No results */
    .no-results {
      text-align: center;
      padding: 48px 20px;
      color: #718096;
    }
    .no-results .icon { font-size: 2.5rem; margin-bottom: 10px; }
    .no-results p { font-size: 0.9rem; }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      padding: 16px;
      background: white;
      border-top: 1px solid #f0f0f0;
    }
    .page-btn {
      padding: 5px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.82rem;
      background: white;
      color: #4a5568;
      font-family: inherit;
    }
    .page-btn:hover:not(:disabled) { background: #ebf8ff; border-color: #90cdf4; }
    .page-btn.active { background: #3182ce; color: white; border-color: #3182ce; }
    .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .page-info { font-size: 0.82rem; color: #718096; padding: 0 4px; }

    /* Data info */
    .data-info-bar {
      display: none;
      align-items: center;
      justify-content: space-between;
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 8px 14px;
      margin-bottom: 14px;
      font-size: 0.82rem;
      color: #4a5568;
    }
    .data-info-bar .reload-btn {
      color: #3182ce;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 0.82rem;
      padding: 0;
      font-family: inherit;
    }
    .data-info-bar .reload-btn:hover { text-decoration: underline; }

    /* Stats cards */
    .stats-row {
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }
    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 14px 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.07);
      text-align: center;
    }
    .stat-card .stat-num {
      font-size: 1.6rem;
      font-weight: 700;
      line-height: 1;
    }
    .stat-card .stat-label {
      font-size: 0.75rem;
      color: #718096;
      margin-top: 4px;
    }
    .stat-normal .stat-num { color: #48bb78; }
    .stat-limited .stat-num { color: #ed8936; }
    .stat-stopped .stat-num { color: #e53e3e; }
    .stat-total .stat-num { color: #4299e1; }

    /* Watchlist section */
    .watchlist-section {
      display: none;
    }
    .watchlist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .watchlist-title {
      font-size: 1rem;
      font-weight: 700;
      color: #2d3748;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .watchlist-subtitle {
      font-size: 0.82rem;
      color: #718096;
      font-weight: 400;
    }
    .watchlist-clear-btn {
      padding: 5px 12px;
      background: #fff5f5;
      border: 1px solid #feb2b2;
      border-radius: 6px;
      color: #c53030;
      font-size: 0.8rem;
      cursor: pointer;
      font-family: inherit;
    }
    .watchlist-clear-btn:hover { background: #fed7d7; }
    .watchlist-empty {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
      background: white;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .watchlist-empty .icon { font-size: 3rem; margin-bottom: 12px; }
    .watchlist-empty p { font-size: 0.9rem; }

    @media (max-width: 640px) {
      .header h1 { font-size: 1.1rem; }
      .header-watch-btn span:not(.watch-badge) { display: none; }
      .search-row { flex-direction: column; }
      .results-header { flex-direction: column; align-items: flex-start; gap: 8px; }
      /* 規格単位・YJコード・停止理由・解消見込みを非表示 */
      thead th:nth-child(5), tbody td:nth-child(5),
      thead th:nth-child(6), tbody td:nth-child(6),
      thead th:nth-child(8), tbody td:nth-child(8),
      thead th:nth-child(9), tbody td:nth-child(9) { display: none; }
      td.brand-name { min-width: 120px; }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div>
      <h1>医薬品供給状況検索システム</h1>
      <p>厚生労働省「医療用医薬品供給状況」Excelファイルを読み込み、出荷状況を検索できます</p>
    </div>
    <button class="header-watch-btn" id="watchlistToggle" onclick="toggleWatchlistView()" title="ウォッチリスト">
      &#x1F514;
      <span>ウォッチリスト</span>
      <span class="watch-badge" id="watchlistCount">0</span>
    </button>
  </div>
</div>

<div class="container">

  <!-- Notification banner -->
  <div class="notif-banner" id="notifBanner"></div>

  <!-- Notification permission prompt -->
  <div class="notif-prompt" id="notifPrompt">
    <div class="notif-prompt-text">&#x1F514; ウォッチ中の医薬品の出荷状況が変わったとき、ブラウザ通知でお知らせできます</div>
    <button class="notif-prompt-btn" onclick="requestNotifPermission()">通知を許可する</button>
    <button style="background:none; border:none; cursor:pointer; color:#7b341e; font-size:1rem; padding:0 4px;" onclick="dismissNotifPrompt()" title="閉じる">&#x2715;</button>
  </div>

  <!-- Auto-load status -->
  <div class="status-bar loading" id="autoLoadBar" style="display:none; margin-bottom:12px;">
    <div class="spinner"></div>
    <span id="autoLoadText">最新データを自動読み込み中...</span>
  </div>

  <!-- Info box (shown only when auto-load fails) -->
  <div class="info-box" id="infoBox" style="display:none;">
    <strong>データが取得できませんでした。</strong>
    厚生労働省のサイトからExcelを手動でダウンロードしてアップロードしてください。<br>
    <a class="mhlw-link" href="https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/kenkou_iryou/iryou/kouhatu-iyaku/04_00003.html" target="_blank" rel="noopener">
      &#x1F517; 厚生労働省 医療用医薬品供給状況ページを開く
    </a>
  </div>

  <!-- Data info bar -->
  <div class="data-info-bar" id="dataInfoBar">
    <span id="dataInfoText"></span>
    <button class="reload-btn" onclick="resetApp()">&#x21BA; 別のファイルを読み込む</button>
  </div>

  <!-- Stats cards -->
  <div class="stats-row" id="statsRow">
    <div class="stat-card stat-total">
      <div class="stat-num" id="statTotal">0</div>
      <div class="stat-label">総品目数</div>
    </div>
    <div class="stat-card stat-normal">
      <div class="stat-num" id="statNormal">0</div>
      <div class="stat-label">通常出荷</div>
    </div>
    <div class="stat-card stat-limited">
      <div class="stat-num" id="statLimited">0</div>
      <div class="stat-label">限定出荷</div>
    </div>
    <div class="stat-card stat-stopped">
      <div class="stat-num" id="statStopped">0</div>
      <div class="stat-label">供給停止</div>
    </div>
  </div>

  <!-- Upload section -->
  <div class="upload-section" id="uploadSection">
    <div class="upload-area" id="uploadArea"
         onclick="document.getElementById('fileInput').click()"
         ondragover="handleDragOver(event)"
         ondragleave="handleDragLeave(event)"
         ondrop="handleDrop(event)">
      <div class="upload-icon">&#x1F4C2;</div>
      <h3>Excelファイルをアップロード</h3>
      <p>ここにファイルをドラッグ＆ドロップ、またはクリックして選択</p>
      <p style="margin-top:4px; font-size:0.78rem;">対応形式：.xlsx / .xls</p>
      <button class="upload-btn" onclick="event.stopPropagation(); document.getElementById('fileInput').click()">
        ファイルを選択
      </button>
    </div>
    <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
    <div class="status-bar" id="statusBar">
      <div class="spinner" id="statusSpinner"></div>
      <span id="statusText"></span>
    </div>
  </div>

  <!-- Search section -->
  <div class="search-section" id="searchSection">
    <div class="search-row">
      <input type="text" class="search-input" id="searchInput"
             placeholder="医薬品名（品名・成分名・メーカー）で検索..."
             oninput="handleSearchInput()"
             onkeydown="if(event.key==='Enter') performSearch()">
      <button class="search-btn" onclick="performSearch()">検索</button>
      <button class="clear-btn" onclick="clearSearch()">クリア</button>
    </div>
    <div class="search-hint">
      <span>スペース区切りで複数キーワード検索</span>
      <div class="mode-toggle">
        <button class="mode-btn active" id="modeAnd" onclick="setSearchMode('and')">AND</button>
        <button class="mode-btn" id="modeOr" onclick="setSearchMode('or')">OR</button>
      </div>
    </div>
    <div class="filter-label">出荷状況でフィルタ</div>
    <div class="filter-row">
      <button class="filter-btn all active" onclick="setFilter('all', this)">すべて</button>
      <button class="filter-btn normal" onclick="setFilter('normal', this)">&#x25CF; 通常出荷</button>
      <button class="filter-btn limited" onclick="setFilter('limited', this)">&#x26A0; 限定出荷</button>
      <button class="filter-btn stopped" onclick="setFilter('stopped', this)">&#x2715; 供給停止</button>
    </div>
  </div>

  <!-- Results section -->
  <div class="results-section" id="resultsSection">
    <div class="results-header">
      <div class="results-count" id="resultsCount"></div>
      <button class="export-btn" onclick="exportCSV()">&#x1F4E5; CSVエクスポート</button>
    </div>
    <div class="table-wrapper">
      <div class="table-scroll">
        <table id="resultsTable">
          <thead>
            <tr>
              <th class="watch-col" title="ウォッチリスト">&#x2605;</th>
              <th>品名</th>
              <th>成分名</th>
              <th>製造販売業者</th>
              <th>規格単位</th>
              <th>YJコード</th>
              <th>出荷状況</th>
              <th>停止理由</th>
              <th>解消見込み</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <!-- Watchlist section -->
  <div class="watchlist-section" id="watchlistSection">
    <div class="watchlist-header">
      <div class="watchlist-title">
        &#x1F514; ウォッチリスト
        <span class="watchlist-subtitle" id="watchlistSubtitle"></span>
      </div>
      <button class="watchlist-clear-btn" onclick="clearWatchlist()">リストをクリア</button>
    </div>
    <div id="watchlistItems"></div>
  </div>

</div>

<script>
  // =========================================================
  // State
  // =========================================================
  let allData = [];
  let filteredData = [];
  let currentFilter = 'all';
  let currentSearch = '';
  let searchMode = 'and';
  let currentPage = 1;
  const PAGE_SIZE = 50;
  let showingWatchlist = false;

  // =========================================================
  // Column indices (0-based)
  // =========================================================
  const COL = {
    DRUG_CLASS: 0,
    PHARM_CLASS: 1,
    GENERIC: 2,
    UNIT: 3,
    YJ: 4,
    BRAND: 5,
    MAKER: 6,
    PRODUCT_TYPE: 7,
    BASIC: 8,
    ENSURE: 9,
    PRICE_DATE: 10,
    STATUS: 11,
    UPDATE_DATE: 12,
    REASON: 13,
    RESOLUTION: 14,
    RESOLUTION_DATE: 15,
  };

  // =========================================================
  // Watchlist (ウォッチリスト)
  // =========================================================
  const WATCHLIST_KEY = 'iyakuhin_watchlist_v1';
  let watchlist = {}; // { [yjCode]: { brand, generic, maker, unit, prevStatus } }

  function loadWatchlist() {
    try {
      watchlist = JSON.parse(localStorage.getItem(WATCHLIST_KEY) || '{}');
    } catch(e) {
      watchlist = {};
    }
    updateWatchlistBadge();
  }

  function saveWatchlist() {
    localStorage.setItem(WATCHLIST_KEY, JSON.stringify(watchlist));
    updateWatchlistBadge();
  }

  function toggleWatch(yjCode, brand, generic, maker, unit, currentStatus) {
    if (watchlist[yjCode]) {
      delete watchlist[yjCode];
    } else {
      watchlist[yjCode] = { brand, generic, maker, unit, prevStatus: currentStatus };
    }
    saveWatchlist();
    // Update all buttons for this YJ code
    document.querySelectorAll(`.watch-btn[data-yj="${CSS.escape(yjCode)}"]`).forEach(btn => {
      applyWatchBtnStyle(btn, !!watchlist[yjCode]);
    });
    if (showingWatchlist) renderWatchlist();
  }

  function applyWatchBtnStyle(btn, watched) {
    btn.textContent = watched ? '\u2605' : '\u2606';
    btn.title = watched ? 'ウォッチリストから削除' : 'ウォッチリストに追加';
    if (watched) btn.classList.add('watched');
    else btn.classList.remove('watched');
  }

  function updateWatchlistBadge() {
    const count = Object.keys(watchlist).length;
    document.getElementById('watchlistCount').textContent = count;
  }

  function clearWatchlist() {
    if (!confirm('ウォッチリストをすべてクリアしますか？')) return;
    watchlist = {};
    saveWatchlist();
    renderWatchlist();
    // Refresh star buttons in main table
    document.querySelectorAll('.watch-btn').forEach(btn => applyWatchBtnStyle(btn, false));
  }

  // =========================================================
  // Status change detection
  // =========================================================
  function checkStatusChanges() {
    if (Object.keys(watchlist).length === 0) return;

    // Build current status map
    const statusMap = {};
    allData.forEach(row => {
      const yj = String(row[COL.YJ] || '');
      if (yj) statusMap[yj] = String(row[COL.STATUS] || '');
    });

    const improved = [];
    const worsened = [];
    const ORDER = { stopped: 0, limited: 1, normal: 2, unknown: -1 };
    let changed = false;

    Object.entries(watchlist).forEach(([yj, item]) => {
      const currentStatus = statusMap[yj];
      if (currentStatus === undefined) return;
      const prevStatus = item.prevStatus;

      if (prevStatus && prevStatus !== currentStatus) {
        const prevCls = classifyStatus(prevStatus);
        const currCls = classifyStatus(currentStatus);
        const entry = { yj, brand: item.brand, prevStatus, currentStatus, prevCls, currCls };
        if ((ORDER[currCls] ?? -1) > (ORDER[prevCls] ?? -1)) improved.push(entry);
        else worsened.push(entry);
        watchlist[yj].prevStatus = currentStatus;
        changed = true;
      } else if (!prevStatus) {
        watchlist[yj].prevStatus = currentStatus;
        changed = true;
      }
    });

    if (changed) saveWatchlist();

    if (improved.length > 0 || worsened.length > 0) {
      showNotificationBanner(improved, worsened);
      sendBrowserNotifications(improved);
    }

    // Show permission prompt if user has watchlist but hasn't granted/denied yet
    if (Object.keys(watchlist).length > 0 && 'Notification' in window && Notification.permission === 'default') {
      document.getElementById('notifPrompt').style.display = 'flex';
    }
  }

  function showNotificationBanner(improved, worsened) {
    const banner = document.getElementById('notifBanner');
    let html = `<div class="notif-banner-title">&#x1F4E2; ウォッチ中の医薬品に出荷状況の変化がありました</div>`;

    if (improved.length > 0) {
      html += `<div class="notif-section-title">&#x2705; 出荷再開・改善 (${improved.length}件)</div>`;
      improved.forEach(c => {
        html += `<div class="notif-item improved">
          <span class="notif-drug">${escHtml(c.brand)}</span>
          <span class="notif-arrow">${escHtml(getStatusLabel(c.prevStatus))} &#x2192; ${escHtml(getStatusLabel(c.currentStatus))}</span>
        </div>`;
      });
    }
    if (worsened.length > 0) {
      html += `<div class="notif-section-title" style="margin-top:${improved.length > 0 ? '10px' : '0'};">&#x26A0;&#xFE0F; 出荷状況悪化 (${worsened.length}件)</div>`;
      worsened.forEach(c => {
        html += `<div class="notif-item worsened">
          <span class="notif-drug">${escHtml(c.brand)}</span>
          <span class="notif-arrow">${escHtml(getStatusLabel(c.prevStatus))} &#x2192; ${escHtml(getStatusLabel(c.currentStatus))}</span>
        </div>`;
      });
    }

    html += `<div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
      <button class="notif-close-btn" onclick="document.getElementById('notifBanner').style.display='none'">&#x2715; 閉じる</button>
      <button class="notif-allow-btn" onclick="toggleWatchlistView()">&#x1F514; ウォッチリストで確認</button>
    </div>`;

    banner.innerHTML = html;
    banner.style.display = 'block';
  }

  function getStatusLabel(statusVal) {
    const s = String(statusVal || '');
    if (s.startsWith('①') || s.includes('通常出荷')) return '通常出荷';
    if (s.includes('供給停止') || s.startsWith('⑤')) return '供給停止';
    if (s.includes('自社の事情') || s.startsWith('②')) return '限定出荷（自社）';
    if (s.includes('他社品') || s.startsWith('③')) return '限定出荷（他社影響）';
    if (s.includes('限定出荷') || s.startsWith('④')) return '限定出荷';
    return s.slice(0, 12) || '不明';
  }

  async function sendBrowserNotifications(improved) {
    if (!('Notification' in window) || Notification.permission !== 'granted' || improved.length === 0) return;
    improved.slice(0, 5).forEach(c => {
      new Notification(`入荷情報: ${c.brand}`, {
        body: `${getStatusLabel(c.prevStatus)} → ${getStatusLabel(c.currentStatus)}`,
        tag: `iyakuhin-${c.yj}`,
      });
    });
  }

  async function requestNotifPermission() {
    if (!('Notification' in window)) return;
    const perm = await Notification.requestPermission();
    if (perm === 'granted') {
      document.getElementById('notifPrompt').style.display = 'none';
    }
  }

  function dismissNotifPrompt() {
    document.getElementById('notifPrompt').style.display = 'none';
    localStorage.setItem('iyakuhin_notif_dismissed', '1');
  }

  // =========================================================
  // Watchlist View
  // =========================================================
  function toggleWatchlistView() {
    showingWatchlist = !showingWatchlist;
    const btn = document.getElementById('watchlistToggle');

    if (showingWatchlist) {
      btn.classList.add('active');
      document.getElementById('watchlistSection').style.display = 'block';
      document.getElementById('searchSection').style.display = 'none';
      document.getElementById('resultsSection').style.display = 'none';
      document.getElementById('statsRow').style.display = 'none';
      renderWatchlist();
    } else {
      btn.classList.remove('active');
      document.getElementById('watchlistSection').style.display = 'none';
      if (allData.length > 0) {
        document.getElementById('searchSection').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('statsRow').style.display = 'grid';
      }
    }
  }

  function renderWatchlist() {
    const container = document.getElementById('watchlistItems');
    const entries = Object.entries(watchlist);
    const subtitle = document.getElementById('watchlistSubtitle');
    subtitle.textContent = `${entries.length} 件`;

    if (entries.length === 0) {
      container.innerHTML = `<div class="watchlist-empty">
        <div class="icon">&#x1F514;</div>
        <p>ウォッチリストが空です</p>
        <p style="font-size:0.82rem; color:#a0aec0; margin-top:8px;">
          検索結果の &#x2606; をクリックして医薬品を追加できます
        </p>
      </div>`;
      return;
    }

    // Build current data map
    const statusMap = {};
    allData.forEach(row => {
      const yj = String(row[COL.YJ] || '');
      if (yj) statusMap[yj] = row;
    });

    const rows = entries.map(([yj, item]) => {
      const row = statusMap[yj];
      const status = row ? row[COL.STATUS] : '';
      const reason = row ? String(row[COL.REASON] || '') : '';
      const resolution = row ? String(row[COL.RESOLUTION] || '') : '';
      const prevStatus = item.prevStatus;
      const changed = prevStatus && prevStatus !== status;
      const ORDER = { stopped: 0, limited: 1, normal: 2, unknown: -1 };
      const improved = changed && (ORDER[classifyStatus(status)] ?? -1) > (ORDER[classifyStatus(prevStatus)] ?? -1);

      const yjEsc = escAttr(yj);
      const brandEsc = escAttr(item.brand);
      const genericEsc = escAttr(item.generic);
      const makerEsc = escAttr(item.maker);
      const unitEsc = escAttr(item.unit);
      const statusEsc = escAttr(status);

      return `<tr class="${improved ? 'status-changed' : ''}">
        <td class="watch-col">
          <button class="watch-btn watched" data-yj="${yjEsc}"
            onclick="toggleWatch('${yjEsc}','${brandEsc}','${genericEsc}','${makerEsc}','${unitEsc}','${statusEsc}')"
            title="ウォッチリストから削除">&#x2605;</button>
        </td>
        <td class="brand-name">${escHtml(item.brand)}${improved ? ' <span style="background:#c6f6d5;color:#276749;font-size:0.72rem;padding:1px 6px;border-radius:10px;font-weight:600;">&#x2605; 再開</span>' : ''}</td>
        <td class="generic-name">${escHtml(item.generic)}</td>
        <td class="manufacturer">${escHtml(item.maker)}</td>
        <td class="unit">${escHtml(item.unit)}</td>
        <td class="yj-code">${escHtml(yj)}</td>
        <td class="status-cell">
          ${buildBadge(status)}
          ${changed ? `<span class="prev-status">前回: ${escHtml(getStatusLabel(prevStatus))}</span>` : ''}
        </td>
        <td class="reason">${escHtml(reason.replace(/^[１-９\d]．\s*/, ''))}</td>
        <td class="reason">${escHtml(resolution.replace(/^[ア-オA-Z]．\s*/, ''))}</td>
      </tr>`;
    }).join('');

    container.innerHTML = `<div class="table-wrapper"><div class="table-scroll">
      <table>
        <thead><tr>
          <th class="watch-col" title="ウォッチリスト">&#x2605;</th>
          <th>品名</th><th>成分名</th><th>製造販売業者</th>
          <th>規格単位</th><th>YJコード</th>
          <th>出荷状況</th><th>停止理由</th><th>解消見込み</th>
        </tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div></div>`;
  }

  // =========================================================
  // Status classification
  // =========================================================
  function classifyStatus(val) {
    if (!val) return 'unknown';
    const s = String(val);
    if (s.includes('供給停止') || s.startsWith('⑤')) return 'stopped';
    if (s.includes('限定出荷') || s.startsWith('②') || s.startsWith('③') || s.startsWith('④')) return 'limited';
    if (s.includes('通常出荷') || s.startsWith('①')) return 'normal';
    return 'unknown';
  }

  function buildBadge(val) {
    const s = String(val || '');
    const cls = classifyStatus(val);
    const dotCls = cls === 'normal' ? 'dot-normal' : cls === 'limited' ? 'dot-limited' : cls === 'stopped' ? 'dot-stopped' : 'dot-unknown';
    const badgeCls = cls === 'normal' ? 'badge-normal'
                   : s.includes('自社') ? 'badge-limited-self'
                   : s.includes('他社') ? 'badge-limited-other'
                   : cls === 'limited' ? 'badge-limited-misc'
                   : cls === 'stopped' ? 'badge-stopped'
                   : 'badge-unknown';
    let label = s;
    if (s.startsWith('①')) label = '通常出荷';
    else if (s.includes('自社の事情')) label = '限定出荷（自社）';
    else if (s.includes('他社品の影響')) label = '限定出荷（他社影響）';
    else if (s.includes('その他')) label = '限定出荷（その他）';
    else if (s.includes('供給停止')) label = '供給停止';
    return `<span class="badge ${badgeCls}"><span class="dot ${dotCls}"></span>${escHtml(label)}</span>`;
  }

  // =========================================================
  // Drag & Drop
  // =========================================================
  function handleDragOver(e) {
    e.preventDefault();
    document.getElementById('uploadArea').classList.add('drag-over');
  }
  function handleDragLeave(e) {
    document.getElementById('uploadArea').classList.remove('drag-over');
  }
  function handleDrop(e) {
    e.preventDefault();
    document.getElementById('uploadArea').classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) processFile(file);
  }
  function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) processFile(file);
  }

  // =========================================================
  // File processing
  // =========================================================
  function processFile(file) {
    if (!file.name.match(/\.(xlsx|xls)$/i)) {
      showStatus('error', 'Excelファイル（.xlsx / .xls）を選択してください');
      return;
    }
    showStatus('loading', `「${file.name}」を読み込んでいます...`);

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
        const sheetName = workbook.SheetNames[0];
        const ws = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

        const dataRows = [];
        let headerFound = false;
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const statusVal = row[COL.STATUS] ? String(row[COL.STATUS]) : '';
          if (!headerFound && (statusVal.startsWith('①') || statusVal.startsWith('②') || statusVal.startsWith('③') || statusVal.startsWith('④') || statusVal.startsWith('⑤'))) {
            headerFound = true;
          }
          if (headerFound) {
            const brand = String(row[COL.BRAND] || '').trim();
            const generic = String(row[COL.GENERIC] || '').trim();
            if (brand || generic) dataRows.push(row);
          }
        }

        if (dataRows.length === 0) {
          showStatus('error', 'データが見つかりませんでした。正しいファイルか確認してください。');
          return;
        }

        allData = dataRows;
        hideStatus();
        initApp(file.name, file.lastModified);
      } catch (err) {
        showStatus('error', `読み込みエラー: ${err.message}`);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function initApp(filename, modDate, fetchDate) {
    let normal = 0, limited = 0, stopped = 0;
    allData.forEach(row => {
      const cls = classifyStatus(row[COL.STATUS]);
      if (cls === 'normal') normal++;
      else if (cls === 'limited') limited++;
      else if (cls === 'stopped') stopped++;
    });

    document.getElementById('statTotal').textContent = allData.length.toLocaleString();
    document.getElementById('statNormal').textContent = normal.toLocaleString();
    document.getElementById('statLimited').textContent = limited.toLocaleString();
    document.getElementById('statStopped').textContent = stopped.toLocaleString();

    let dateLabel = '';
    if (fetchDate) dateLabel = `　データ更新日：${fetchDate}`;
    else if (modDate) dateLabel = `　ファイル更新日：${new Date(modDate).toLocaleDateString('ja-JP')}`;
    document.getElementById('dataInfoText').textContent =
      `${filename}　全 ${allData.length.toLocaleString()} 品目${dateLabel}`;

    document.getElementById('uploadSection').style.display = 'none';
    document.getElementById('infoBox').style.display = 'none';
    document.getElementById('dataInfoBar').style.display = 'flex';
    document.getElementById('statsRow').style.display = 'grid';
    document.getElementById('searchSection').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'block';

    currentFilter = 'all';
    currentSearch = '';
    currentPage = 1;
    applyFilters();

    // Check for status changes in watchlist
    checkStatusChanges();

    // Show notif prompt if dismissed flag not set
    if (
      Object.keys(watchlist).length > 0 &&
      'Notification' in window &&
      Notification.permission === 'default' &&
      !localStorage.getItem('iyakuhin_notif_dismissed')
    ) {
      document.getElementById('notifPrompt').style.display = 'flex';
    }
  }

  // =========================================================
  // Search & Filter
  // =========================================================
  let searchTimer = null;
  function handleSearchInput() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(performSearch, 300);
  }

  function performSearch() {
    currentSearch = document.getElementById('searchInput').value.trim();
    currentPage = 1;
    applyFilters();
  }

  function setSearchMode(mode) {
    searchMode = mode;
    document.getElementById('modeAnd').classList.toggle('active', mode === 'and');
    document.getElementById('modeOr').classList.toggle('active', mode === 'or');
    performSearch();
  }

  function clearSearch() {
    document.getElementById('searchInput').value = '';
    currentSearch = '';
    currentPage = 1;
    applyFilters();
  }

  function setFilter(filter, btn) {
    currentFilter = filter;
    currentPage = 1;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    applyFilters();
  }

  function applyFilters() {
    const terms = currentSearch.toLowerCase().split(/\s+/).filter(Boolean);
    filteredData = allData.filter(row => {
      if (currentFilter !== 'all') {
        if (classifyStatus(row[COL.STATUS]) !== currentFilter) return false;
      }
      if (terms.length > 0) {
        const fields = [
          String(row[COL.BRAND] || '').toLowerCase(),
          String(row[COL.GENERIC] || '').toLowerCase(),
          String(row[COL.MAKER] || '').toLowerCase(),
          String(row[COL.YJ] || '').toLowerCase(),
          String(row[COL.UNIT] || '').toLowerCase(),
        ];
        const matchesTerm = term => fields.some(f => f.includes(term));
        if (searchMode === 'and') {
          if (!terms.every(matchesTerm)) return false;
        } else {
          if (!terms.some(matchesTerm)) return false;
        }
      }
      return true;
    });
    renderResults();
  }

  // =========================================================
  // Rendering
  // =========================================================
  function escHtml(s) {
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function escAttr(s) {
    return String(s || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
  }

  function highlightMatch(text, query) {
    if (!query) return escHtml(text);
    const terms = query.toLowerCase().split(/\s+/).filter(Boolean);
    if (terms.length === 0) return escHtml(text);
    const t = String(text || '');
    const escaped = terms.map(s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
    const regex = new RegExp(`(${escaped.join('|')})`, 'gi');
    return t.split(regex).map((part, i) =>
      i % 2 === 1
        ? `<mark style="background:#fef08a;padding:0 1px">${escHtml(part)}</mark>`
        : escHtml(part)
    ).join('');
  }

  function renderResults() {
    const total = filteredData.length;
    const start = (currentPage - 1) * PAGE_SIZE;
    const end = Math.min(start + PAGE_SIZE, total);
    const pageData = filteredData.slice(start, end);

    const q = currentSearch;
    let countText = `<strong>${total.toLocaleString()}</strong> 品目`;
    if (q) countText += ` 「${escHtml(q)}」の検索結果`;
    if (currentFilter !== 'all') {
      const labels = { normal:'通常出荷', limited:'限定出荷', stopped:'供給停止' };
      countText += ` [${labels[currentFilter] || currentFilter}]`;
    }
    document.getElementById('resultsCount').innerHTML = countText;

    const tbody = document.getElementById('tableBody');
    if (pageData.length === 0) {
      tbody.innerHTML = `<tr><td colspan="9">
        <div class="no-results">
          <div class="icon">&#x1F50D;</div>
          <p>該当する医薬品が見つかりませんでした</p>
        </div>
      </td></tr>`;
    } else {
      tbody.innerHTML = pageData.map(row => {
        const brand   = String(row[COL.BRAND] || '');
        const generic = String(row[COL.GENERIC] || '');
        const maker   = String(row[COL.MAKER] || '');
        const unit    = String(row[COL.UNIT] || '');
        const yj      = String(row[COL.YJ] || '');
        const status  = row[COL.STATUS];
        const reason  = String(row[COL.REASON] || '');
        const resolution = String(row[COL.RESOLUTION] || '');
        const watched = isWatched(yj);

        const yjEsc     = escAttr(yj);
        const brandEsc  = escAttr(brand);
        const genericEsc = escAttr(generic);
        const makerEsc  = escAttr(maker);
        const unitEsc   = escAttr(unit);
        const statusEsc = escAttr(String(status || ''));

        return `<tr>
          <td class="watch-col">
            <button class="watch-btn ${watched ? 'watched' : ''}" data-yj="${yjEsc}"
              onclick="toggleWatch('${yjEsc}','${brandEsc}','${genericEsc}','${makerEsc}','${unitEsc}','${statusEsc}')"
              title="${watched ? 'ウォッチリストから削除' : 'ウォッチリストに追加'}">${watched ? '\u2605' : '\u2606'}</button>
          </td>
          <td class="brand-name">${highlightMatch(brand, q)}</td>
          <td class="generic-name">${highlightMatch(generic, q)}</td>
          <td class="manufacturer">${highlightMatch(maker, q)}</td>
          <td class="unit">${escHtml(unit)}</td>
          <td class="yj-code">${escHtml(yj)}</td>
          <td class="status-cell">${buildBadge(status)}</td>
          <td class="reason">${escHtml(reason.replace(/^[１-９\d]．\s*/,''))}</td>
          <td class="reason">${escHtml(resolution.replace(/^[ア-オA-Z]．\s*/,''))}</td>
        </tr>`;
      }).join('');
    }

    renderPagination(total);
  }

  function isWatched(yjCode) {
    return !!watchlist[yjCode];
  }

  function renderPagination(total) {
    const totalPages = Math.ceil(total / PAGE_SIZE);
    const pag = document.getElementById('pagination');
    if (totalPages <= 1) { pag.innerHTML = ''; return; }

    let html = '';
    html += `<button class="page-btn" onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lsaquo; 前へ</button>`;

    const range = [];
    range.push(1);
    if (currentPage > 3) range.push('...');
    for (let i = Math.max(2, currentPage - 1); i <= Math.min(totalPages - 1, currentPage + 1); i++) range.push(i);
    if (currentPage < totalPages - 2) range.push('...');
    if (totalPages > 1) range.push(totalPages);

    range.forEach(p => {
      if (p === '...') {
        html += `<span class="page-info">…</span>`;
      } else {
        html += `<button class="page-btn ${p === currentPage ? 'active' : ''}" onclick="goPage(${p})">${p}</button>`;
      }
    });

    html += `<button class="page-btn" onclick="goPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>次へ &rsaquo;</button>`;
    html += `<span class="page-info">${(currentPage - 1) * PAGE_SIZE + 1}–${Math.min(currentPage * PAGE_SIZE, total)} / ${total.toLocaleString()}</span>`;
    pag.innerHTML = html;
  }

  function goPage(page) {
    const totalPages = Math.ceil(filteredData.length / PAGE_SIZE);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderResults();
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // =========================================================
  // Status helpers
  // =========================================================
  function showStatus(type, text) {
    const bar = document.getElementById('statusBar');
    const spinner = document.getElementById('statusSpinner');
    bar.className = `status-bar ${type}`;
    bar.style.display = 'flex';
    spinner.style.display = type === 'loading' ? 'block' : 'none';
    document.getElementById('statusText').textContent = text;
  }
  function hideStatus() {
    document.getElementById('statusBar').style.display = 'none';
  }

  // =========================================================
  // Reset
  // =========================================================
  function resetApp() {
    allData = [];
    filteredData = [];
    currentFilter = 'all';
    currentSearch = '';
    currentPage = 1;
    showingWatchlist = false;

    document.getElementById('fileInput').value = '';
    document.getElementById('searchInput').value = '';
    document.getElementById('uploadSection').style.display = 'block';
    document.getElementById('infoBox').style.display = 'block';
    document.getElementById('dataInfoBar').style.display = 'none';
    document.getElementById('statsRow').style.display = 'none';
    document.getElementById('searchSection').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('watchlistSection').style.display = 'none';
    document.getElementById('watchlistToggle').classList.remove('active');
    hideStatus();

    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.filter-btn.all').classList.add('active');
  }

  // =========================================================
  // data.json 自動読み込み
  // =========================================================
  async function tryAutoLoad() {
    const bar = document.getElementById('autoLoadBar');
    bar.style.display = 'flex';
    try {
      const resp = await fetch('./data.json', { cache: 'no-cache' });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const json = await resp.json();
      if (!json.rows || json.rows.length === 0) throw new Error('データなし');

      bar.style.display = 'none';
      allData = json.rows;
      initApp(`厚労省データ（${json.fetchDate} 更新）`, null, json.fetchDate);
    } catch (e) {
      bar.style.display = 'none';
      document.getElementById('infoBox').style.display = 'block';
      document.getElementById('uploadSection').style.display = 'block';
    }
  }

  // =========================================================
  // CSV Export
  // =========================================================
  function exportCSV() {
    if (filteredData.length === 0) return;
    const headers = ['品名', '成分名', '製造販売業者', '規格単位', 'YJコード', '薬剤区分', '製品区分', '出荷状況', '停止理由', '解消見込み', '解消見込み時期'];
    const rows = filteredData.map(row => [
      row[COL.BRAND], row[COL.GENERIC], row[COL.MAKER], row[COL.UNIT], row[COL.YJ],
      row[COL.DRUG_CLASS], row[COL.PRODUCT_TYPE], row[COL.STATUS],
      row[COL.REASON], row[COL.RESOLUTION], row[COL.RESOLUTION_DATE]
    ]);
    const csv = [headers, ...rows].map(r =>
      r.map(cell => {
        const s = String(cell || '').replace(/"/g, '""');
        return s.includes(',') || s.includes('"') || s.includes('\n') ? `"${s}"` : s;
      }).join(',')
    ).join('\r\n');
    const bom = '\uFEFF';
    const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `医薬品供給状況_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // =========================================================
  // Init
  // =========================================================
  window.addEventListener('DOMContentLoaded', () => {
    loadWatchlist();
    tryAutoLoad();
  });
</script>

</body>
</html>
